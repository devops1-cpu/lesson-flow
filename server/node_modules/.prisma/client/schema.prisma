generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  HOD
  TEACHER
  STUDENT
  PARENT
  PROCESS_DEPT
}

enum LessonStatus {
  DRAFT
  SUBMITTED
  CHANGES_REQUESTED
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum AvailabilityState {
  AVAILABLE
  CONDITIONAL
  UNAVAILABLE
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(STUDENT)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Department / HOD info
  departmentId String?
  department   Department? @relation("DeptMembers", fields: [departmentId], references: [id])

  // If user is HOD, they head a department
  headedDepartment Department? @relation("DepartmentHead")

  // Relations
  lessonPlans         LessonPlan[]          @relation("CreatedBy")
  approvedPlans       LessonPlan[]          @relation("ApprovedBy")
  classMemberships    ClassMember[]
  parentLinks         ParentStudent[]       @relation("Parent")
  childLinks          ParentStudent[]       @relation("Child")
  classesOwned        Class[]               @relation("ClassOwner")
  teacherAssignments  TeacherAssignment[]
  commentsMade        LessonComment[]       @relation("UserComments")
  slotTeachers        SlotTeacher[]
  teacherAvailability TeacherAvailability[] @relation("TeacherAvailability")
  lessonTeachers      LessonTeacher[]
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  headId String? @unique
  head   User?   @relation("DepartmentHead", fields: [headId], references: [id])

  members  User[]    @relation("DeptMembers")
  courses  Course[]
  subjects Subject[]
}

model Subject {
  id           String      @id @default(uuid())
  name         String
  code         String?
  abbreviation String? // Short code like "M", "Eng", "PE"
  color        String? // Hex color for timetable display
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  teacherAssignments TeacherAssignment[]
  timetableSlots     TimetableSlot[]
  timetableLessons   TimetableLesson[]
  availabilities     SubjectAvailability[]
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  @@unique([name, departmentId])
}

model Course {
  id           String     @id @default(uuid())
  name         String
  code         String?
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  classes   Class[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Class {
  id          String   @id @default(uuid())
  name        String
  section     String?
  subject     String?
  grade       String?
  description String?
  capacity    Int      @default(45)
  coverColor  String   @default("#1a73e8")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Link to Course
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id])

  // Relations
  ownerId              String
  owner                User                  @relation("ClassOwner", fields: [ownerId], references: [id])
  members              ClassMember[]
  lessonPlans          LessonPlan[]
  slotClasses          SlotClass[]
  lessonClasses        LessonClass[]
  timetableAssignments TimetableAssignment[]
  availabilities       ClassAvailability[]
  TeacherAssignment    TeacherAssignment[]
}

// Teacher-Class-Subject mapping (Admin assigns teachers to classes for specific subjects)
model TeacherAssignment {
  id        String   @id @default(uuid())
  teacherId String
  classId   String
  subjectId String
  createdAt DateTime @default(now())

  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId, subjectId])
}

model ClassMember {
  id       String   @id @default(uuid())
  userId   String
  classId  String
  joinedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
}

model LessonPlan {
  id                  String       @id @default(uuid())
  title               String
  subject             String
  grade               String
  objectives          String[]
  materials           String[]
  warmUp              String?
  instruction         String?
  guidedPractice      String?
  independentPractice String?
  closure             String?
  assessment          String?
  differentiation     String?
  homework            String?
  notes               String?
  status              LessonStatus @default(DRAFT)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Advance submission tracking
  advanceDaysRequired Int @default(3)

  // Approval Workflow
  submissionDate  DateTime?
  approvalDate    DateTime?
  approverId      String?
  approver        User?     @relation("ApprovedBy", fields: [approverId], references: [id])
  approvalComment String?

  // AI Readiness
  readinessAssessment ReadinessAssessment?
  ocrSourceUrl        String?

  // Relations
  teacherId            String
  teacher              User                  @relation("CreatedBy", fields: [teacherId], references: [id])
  classId              String?
  class                Class?                @relation(fields: [classId], references: [id])
  resources            Resource[]
  comments             LessonComment[]
  timetableAssignments TimetableAssignment[]
}

model ReadinessAssessment {
  id           String     @id @default(uuid())
  lessonPlanId String     @unique
  lessonPlan   LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)

  score           Int?
  feedback        String?
  questions       Json?
  answers         Json?
  sectionAnalysis Json? // AI critique per section
  status          String  @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resource {
  id        String   @id @default(uuid())
  name      String
  type      String
  url       String
  createdAt DateTime @default(now())

  lessonPlanId String
  lessonPlan   LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
}

model LessonComment {
  id     String     @id @default(uuid())
  planId String
  plan   LessonPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  userId String
  user   User       @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)

  section   String? // e.g., "objectives", "instruction", or null for general
  content   String
  createdAt DateTime @default(now())
}

model ParentStudent {
  id        String @id @default(uuid())
  parentId  String
  studentId String

  parent  User @relation("Parent", fields: [parentId], references: [id], onDelete: Cascade)
  student User @relation("Child", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
}

// ==================== TIMETABLE LESSONS (Edupage-style) ====================

model TimetableLesson {
  id String @id @default(uuid())

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  title String? // For meetings or custom labels

  count    Int       @default(1) // Lessons per week
  length   Int       @default(1) // Periods per lesson (1=single, 2=double)
  roomType RoomType? // Preferred room type (null = any)

  classes  LessonClass[]
  teachers LessonTeacher[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LessonClass {
  id       String          @id @default(uuid())
  lessonId String
  lesson   TimetableLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  classId  String
  class    Class           @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([lessonId, classId])
}

model LessonTeacher {
  id        String          @id @default(uuid())
  lessonId  String
  lesson    TimetableLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   User            @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([lessonId, teacherId])
}

// ==================== TIMETABLING ====================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum RoomType {
  REGULAR
  LAB
  PE
  SPECIALTY
  LIBRARY
  COMPUTER_LAB
}

model Room {
  id          String   @id @default(uuid())
  name        String   @unique
  type        RoomType @default(REGULAR)
  capacity    Int      @default(40)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  timetableSlots TimetableSlot[]
}

model Period {
  id        String   @id @default(uuid())
  number    Int // Period 1, 2, 3...
  startTime String // "08:00"
  endTime   String // "08:40"
  isBreak   Boolean  @default(false)
  label     String? // "Period 1", "Lunch Break", etc.
  createdAt DateTime @default(now())

  timetableSlots TimetableSlot[]

  @@unique([number])
}

model TimetableSlot {
  id        String    @id @default(uuid())
  dayOfWeek DayOfWeek

  periodId String
  period   Period @relation(fields: [periodId], references: [id], onDelete: Cascade)

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  title String?

  roomId String?
  room   Room?   @relation(fields: [roomId], references: [id], onDelete: SetNull)

  classes  SlotClass[]
  teachers SlotTeacher[]

  timetableAssignments TimetableAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SlotClass {
  id      String        @id @default(uuid())
  slotId  String
  slot    TimetableSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  classId String
  class   Class         @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([slotId, classId])
}

model SlotTeacher {
  id        String        @id @default(uuid())
  slotId    String
  slot      TimetableSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   User          @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([slotId, teacherId])
}

model TimetableAssignment {
  id   String   @id @default(uuid())
  date DateTime @db.Date

  slotId String
  slot   TimetableSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  lessonPlanId String
  lessonPlan   LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)

  // Quick lookup relations without joining slot
  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([date, slotId]) // One lesson plan per slot per day
  @@unique([date, classId, slotId]) // One lesson plan per class per slot per day
}

model TeacherAvailability {
  id        String            @id @default(uuid())
  teacherId String
  teacher   User              @relation("TeacherAvailability", fields: [teacherId], references: [id], onDelete: Cascade)
  dayOfWeek DayOfWeek
  periodId  String // Using String to allow matching period ID, or "ALL" / specific numbers
  state     AvailabilityState @default(AVAILABLE)
  createdAt DateTime          @default(now())

  @@unique([teacherId, dayOfWeek, periodId])
}

model ClassAvailability {
  id        String            @id @default(uuid())
  classId   String
  class     Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  dayOfWeek DayOfWeek
  periodId  String
  state     AvailabilityState @default(AVAILABLE)
  createdAt DateTime          @default(now())

  @@unique([classId, dayOfWeek, periodId])
}

model SubjectAvailability {
  id        String            @id @default(uuid())
  subjectId String
  subject   Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  dayOfWeek DayOfWeek
  periodId  String
  state     AvailabilityState @default(AVAILABLE)
  createdAt DateTime          @default(now())

  @@unique([subjectId, dayOfWeek, periodId])
}
